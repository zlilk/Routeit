<!DOCTYPE html>
<html ng-app="dailyRoute">
    <head>
        <meta charset="utf-8">
        <meta name="google-signin-client_id" content="296256466166-pdh58rh53nihcc5tfh184vmautajqsup.apps.googleusercontent.com">
        <title>Daily Route</title>
        <link href='https://fonts.googleapis.com/css?family=Alef' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/style.css">
        <script src="https://apis.google.com/js/platform.js" async defer></script> 
        <style>
            #map {
                height: 200px;
                width: 500px;
            }
        </style>  
    </head>
    <body ng-controller = "dailyController">
        <nav> 
            <a id = "personalProfile" href="http://localhost:8080/userprofile.html"> personalProfile </a>
            <a id = "dailyRoute" href="http://localhost:8080/dailyRoute.html"> dailyRoute </a>
            <a id = "detailedPlan" href="http://localhost:8080/detailedPlan.html"> detailedPlan </a> 
            <div class = "clear"> </div>
        </nav>
        <header id="dailyHeader"> 
            <h1> מסלול יומי </h1>
            <h1>{{currentDate}}</h1>
        </header>
        <main id="dailyMain">
            <section id="dailyMap">
                <div id="map"></div>
            </section>
            <section id="startEnd"> 
                <span> מוצא {{start}} </span> 
                <span> סיום: {{end}} </span> <br>
                <span> משך: {{duration}} שעות </span>
            </section>
            <section id ="routeDesc">
                <h3>תיאור המסלול</h3>
                <p ng-repeat = "desc in descArr">{{desc}}</p>
                <p>רמת קושי: {{diff}}</p>
            </section>
            <section id="dailyMap"> </section>
            <section id="dailySites">
                <h3>אתרים בדרך</h3>
                <p ng-repeat = "site in sitesArr">{{site}}</p>
            </section>
            <section id ="dailyAccomm">
                <h3>מקום לינה</h3>
                <p>{{accommName}}</p>
                <p>{{accommPhone}}</p>
            </section>
            <section id="dailyAlerts">
                <h3>התראות</h3>
                <p ng-repeat = "alert in alertsArr">{{alert}}</p>
            </section>
        </main>
        <footer> 
            <div class="g-signin2 hidden" id = "signInRoute" data-onsuccess="onSignIn"></div>
            <div class = "clear"> </div>
        </footer>
        <script>
            function initMap() {
                var currentRoute = JSON.parse(localStorage.getItem("currentRoute"));
                var dailyCoordsArray = []; // holds one daily section's coords
                // get the current day coords
                var currentDate = new Date(); //today's date
                var currentDayPos = 0;
                var foundDay = false; //flag to check if the trip days have the current date
                for(var i = 0; i< currentRoute.daily_sections.length; i++){
                    var tmpDate = new Date(currentRoute.daily_sections[i].date);
                    if((currentDate.getDate() == tmpDate.getDate()) && (currentDate.getMonth() == tmpDate.getMonth()) && (currentDate.getFullYear() == tmpDate.getFullYear())){
                        currentDayPos = i;
                        foundDay = true;
                        break;
                    }  
                } 
                if(foundDay == true){
                    for(var j=0; j<currentRoute.daily_sections[currentDayPos].coord_array.length; j++){
                        var dailyCoord = {
                            lat: Number(currentRoute.daily_sections[currentDayPos].coord_array[j].lat),
                            lng: Number(currentRoute.daily_sections[currentDayPos].coord_array[j].lng)
                        }
                        dailyCoordsArray.push(dailyCoord);
                    }
                    var centerCoord = dailyCoordsArray[parseInt(dailyCoordsArray.length/2)];
                    var map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 12,
                        center: centerCoord, //{lat: 33.240884, lng: 35.575751},
                        mapTypeId: 'terrain'
                    });
                    var flightPath = new google.maps.Polyline({
                        path: dailyCoordsArray,
                        geodesic: true,
                        strokeColor: '#FF0000',
                        strokeOpacity: 1.0,
                        strokeWeight: 2
                    });
                    flightPath.setMap(map);
                }
            }
            function signOut() {
                var auth2 = gapi.auth2.getAuthInstance();
                auth2.signOut().then(function () {
                    console.log('User signed out.');
                });
                window.location.assign("");
            }
        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClX7NRDum6_i6RO1SXeH9_REWSulwtA5c&callback=initMap">
        </script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
        <script src="js/lib/angular/angular.min.js"></script>
        <script src="js/dailyroute.js"></script>
    </body>
 </html>